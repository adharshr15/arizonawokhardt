<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T+H</title>
    <link href="/styles.css" rel="stylesheet" type="text/css" media="all">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

    <script src="https://kit.fontawesome.com/f936906ae0.js" crossorigin="anonymous"></script>
  </head>
  <body>
    <!--Music Player Header-->
    <div class="header">
      <button class='home-button' onClick="loadPage('home')"><img src="/images/azwLogo.png"></button>
      <button id='previous-track' class="music-controls"><img src="/images/play.png"></button>
      <button id='play-pause-track' class="music-controls"><img src="/images/play.png"></button>
      <button id='next-track' class="music-controls"><img src="/images/play.png"></button>
      <div id="song-title-marquee" class="header-marquee">
        <marquee id="song-title"></marquee>
      </div>
      <select id="playlist-select" class="header-marquee"></select>
      <div id='time-together-marquee' class="header-marquee">
        <marquee id="time-together"></marquee>
      </div>
    </div>

    <!--Main Content of page-->
    <div id="main-content">
      <!--page content is loaded here using loadPage()-->
    </div>
  </body>
</html>

<script>
// Page Loading

// Functions
function loadPage(page) {
  fetch(`${page}.html`)
    .then(res => res.text())
    .then(html => {
      document.getElementById('main-content').innerHTML = html;
      // load music.json file for music page
      if (page === 'music') {
        fetch("assets/music.json")
          .then(res => {
            if (!res.ok) throw new Error('Failed to fetch music.json');
            return res.json();
          })
          .then(data => {
            musicData = data;
            renderFrames(currentPage);
          })
          .catch(err => {
            console.error('Error loading music.json:', err);
          });
      }
    });
}

// Listeners
// window.addEventListener('popstate', (event) => {
//   const state = event.state;
//   if (state && state.page) {
//     loadPage(state.page, false);
//   }
// });
// sets default page
window.addEventListener('DOMContentLoaded', () => {
  const initialPage = location.hash ? location.hash.substring(1) : 'music';
  loadPage(initialPage, false);
});


// Music Player

let isPlaying = true;
let currentSong = new Audio();
let playlists = {};
let track_list = [];
let track_index = 0;

// Variables
const playlistSelect = document.getElementById("playlist-select");
const songTitle = document.getElementById("song-title");
const prevTrackButton = document.getElementById("previous-track");
const playPauseTrackButton = document.getElementById("play-pause-track");
const nextTrackButton = document.getElementById("next-track");

// Functions
function loadTrack(index) {
  if (track_list.length === 0) return; 

  currentSong.src = track_list[index].path;
  document.getElementById('song-title').textContent = String(index + 1) + ". " + track_list[index].name;
  currentSong.load();
}

function playPauseTrack() {
  if (isPlaying) {
    currentSong.pause();
    isPlaying = !isPlaying;
  } else {
    currentSong.play();
    isPlaying = !isPlaying;
  }
}

function nextTrack() {
  if (track_index < track_list.length - 1) {
    track_index++;
  } else {
    track_index = 0;
  }
  loadTrack(track_index);
  currentSong.play();
  currentSong.
  isPlaying = true;
}

function previousTrack() {
  if (track_index > 0) {
    track_index--;
  } 
  loadTrack(track_index);
  currentSong.play();
  isPlaying = true;
}

function changePlaylist() {
  const selected = playlistSelect.value;
  track_list = playlists[selected];
  track_index = 0;
  songTitle.textContent = track_list[0].name;
  loadTrack(track_index);
}


fetch("/assets/mixtapes.json")
  .then(response => response.json())
  .then(data => {
    playlists = data;

    for (let playlistName in playlists) {
      const option = document.createElement("option");
      option.value = playlistName;
      option.textContent = playlistName;
      playlistSelect.appendChild(option);
    }

    // Set default playlist and song title
    const firstPlaylist = Object.keys(playlists)[0];
    if (firstPlaylist) {
      playlistSelect.value = firstPlaylist;
      track_list = playlists[firstPlaylist];
      track_index = 0;
      songTitle.textContent = String(track_index + 1) + ". " + track_list[0].name;
      loadTrack(track_index);
      isPlaying = false;
    }
  });

// Listeners
playlistSelect.addEventListener("change", changePlaylist);
prevTrackButton.addEventListener('click', previousTrack);
playPauseTrackButton.addEventListener('click', playPauseTrack);
nextTrackButton.addEventListener('click', nextTrack);
currentSong.addEventListener('ended', nextTrack);

// Time Together

// Variables
const timeTogether = document.getElementById('time-together');
const startDate = new Date("August 10, 2024 01:00:00");

// Functions
function updateTimeTogether() {
  const now = new Date();
  let diff = now - startDate;

  let seconds = Math.floor(diff / 1000);
  const minutes = Math.floor(seconds / 60);
  const hours = Math.floor(minutes / 60);
  const days = Math.floor(hours / 24);

  const years = Math.floor(days / 365.25);
  const months = Math.floor((days % 365.25) / 30.44);
  const remDays = Math.floor((days % 365.25) % 30.44);

  const remHours = hours % 24;
  const remMinutes = minutes % 60;
  const remSeconds = seconds % 60;

  timeTogether.textContent = 
    `${years} Year${years !== 1 ? 's' : ''}, ` +
    `${months} Month${months !== 1 ? 's' : ''}, ` +
    `${remDays} Day${remDays !== 1 ? 's' : ''}, ` +
    `${remHours} Hour${remHours !== 1 ? 's' : ''}, ` +
    `${remMinutes} Minute${remMinutes !== 1 ? 's' : ''}, ` +
    `${remSeconds} Second${remSeconds !== 1 ? 's' : ''} Together`;
}

updateTimeTogether();

// Update every second
setInterval(updateTimeTogether, 1000);

// Music
// Variables
let musicData = [];
let currentPage = 1;
let itemsPerPage = 6;

// Functions
function renderFrames(page) {
    const container = document.getElementById('music-container');
    container.innerHTML = '';

    const start = (page - 1) * itemsPerPage;
    const end = page * itemsPerPage;
    const pageItems = musicData.slice(start, end);

    // create the <=6 frames for the current page
    pageItems.forEach((track, index) => {
        const globalIndex = start + index;

        const frame = document.createElement('div');
        frame.className = 'music-frame';

        // if track index is even, make left frame
        if (globalIndex % 2 == 0) {
            frame.innerHTML = `
                <img id='cover-art-left' class='cover-art-left' src="${track.art}">
                <div id='inner-right' class="inner-right">
                    <h3>${track.song}</h3>
                    <p class='description'>${track.description}</p>
                    <p class='date'>${track.date}</p>
                </div>
            `;
        } else {
            frame.innerHTML = `
                <div id='inner-left' class="inner-left">
                    <h3>${track.song}</h3>
                    <p class='description'>${track.description}</p>
                    <p class='date'>${track.date}</p>
                </div>
                <img id='cover-art-right' class='cover-art-right' src="${track.art}">
            `;
        }

        container.appendChild(frame);
    });
}

</script>
